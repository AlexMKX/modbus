defaults:
  modbus_master: modbus_master
  device_id: uicpal_0_10v
  name: ${device_id}
  slave_id: 1
  update_interval: 10s
  command_throttle: 200ms
  offline_skip_updates: 5
  max_cmd_retries: 2

packages:
  online_sensor: !include
    file: ../modbus_online/esphome.yaml
    vars:
      modbus_id: ${device_id}_modbus
      device_id: ${device_id}
      name: ${name}

modbus_controller:
  - id: ${device_id}_modbus
    address: ${slave_id}
    modbus_id: ${modbus_master}
    setup_priority: -10
    update_interval: ${update_interval}
    command_throttle: ${command_throttle}
    offline_skip_updates: ${offline_skip_updates}
    max_cmd_retries: ${max_cmd_retries}

sensor:
  - platform: modbus_controller
    modbus_controller_id: ${device_id}_modbus
    id: ${device_id}_ch1_analog_code
    name: "${name} Channel 1 Analog Code"
    register_type: holding
    address: 0x0000
    value_type: U_WORD
    accuracy_decimals: 0
    icon: mdi:counter

  - platform: modbus_controller
    modbus_controller_id: ${device_id}_modbus
    id: ${device_id}_ch2_analog_code
    name: "${name} Channel 2 Analog Code"
    register_type: holding
    address: 0x0001
    value_type: U_WORD
    accuracy_decimals: 0
    icon: mdi:counter

  - platform: modbus_controller
    modbus_controller_id: ${device_id}_modbus
    id: ${device_id}_ch3_analog_code
    name: "${name} Channel 3 Analog Code"
    register_type: holding
    address: 0x0002
    value_type: U_WORD
    accuracy_decimals: 0
    icon: mdi:counter

  - platform: modbus_controller
    modbus_controller_id: ${device_id}_modbus
    id: ${device_id}_ch4_analog_code
    name: "${name} Channel 4 Analog Code"
    register_type: holding
    address: 0x0003
    value_type: U_WORD
    accuracy_decimals: 0
    icon: mdi:counter

  - platform: template
    id: ${device_id}_ch1_v
    name: "${name} Channel 1 Voltage"
    unit_of_measurement: "V"
    accuracy_decimals: 2
    lambda: |-
      if (isnan(id(${device_id}_ch1_analog_code).state)) return NAN;
      return (id(${device_id}_ch1_analog_code).state / 4095.0f) * 10.0f;
    update_interval: ${update_interval}

  - platform: template
    id: ${device_id}_ch2_v
    name: "${name} Channel 2 Voltage"
    unit_of_measurement: "V"
    accuracy_decimals: 2
    lambda: |-
      if (isnan(id(${device_id}_ch2_analog_code).state)) return NAN;
      return (id(${device_id}_ch2_analog_code).state / 4095.0f) * 10.0f;
    update_interval: ${update_interval}

  - platform: template
    id: ${device_id}_ch3_v
    name: "${name} Channel 3 Voltage"
    unit_of_measurement: "V"
    accuracy_decimals: 2
    lambda: |-
      if (isnan(id(${device_id}_ch3_analog_code).state)) return NAN;
      return (id(${device_id}_ch3_analog_code).state / 4095.0f) * 10.0f;
    update_interval: ${update_interval}

  - platform: template
    id: ${device_id}_ch4_v
    name: "${name} Channel 4 Voltage"
    unit_of_measurement: "V"
    accuracy_decimals: 2
    lambda: |-
      if (isnan(id(${device_id}_ch4_analog_code).state)) return NAN;
      return (id(${device_id}_ch4_analog_code).state / 4095.0f) * 10.0f;
    update_interval: ${update_interval}

  - platform: modbus_controller
    modbus_controller_id: ${device_id}_modbus
    id: ${device_id}_device_address_reg
    name: "${name} Device Address Register"
    register_type: holding
    address: 0x07D0
    value_type: U_WORD
    accuracy_decimals: 0
    entity_category: diagnostic
    icon: mdi:numeric

  - platform: modbus_controller
    modbus_controller_id: ${device_id}_modbus
    id: ${device_id}_baud_rate_code_reg
    name: "${name} Baud Rate Code Register"
    register_type: holding
    address: 0x07D1
    value_type: U_WORD
    accuracy_decimals: 0
    entity_category: diagnostic
    icon: mdi:speedometer

  - platform: modbus_controller
    modbus_controller_id: ${device_id}_modbus
    id: ${device_id}_parity_code_reg
    name: "${name} Parity Code Register"
    register_type: holding
    address: 0x07D2
    value_type: U_WORD
    accuracy_decimals: 0
    entity_category: diagnostic
    icon: mdi:code-tags

text_sensor:
  - platform: template
    name: "${name} Baud Rate (decoded)"
    lambda: |-
      int v = (int) id(${device_id}_baud_rate_code_reg).state;
      switch (v) {
        case 0: return {"2400"};
        case 1: return {"4800"};
        case 2: return {"9600"};
        case 3: return {"19200"};
        case 4: return {"38400"};
        case 5: return {"57600"};
        case 6: return {"115200"};
        case 7: return {"1200"};
        default: return {"unknown"};
      }
    update_interval: ${update_interval}

  - platform: template
    name: "${name} Parity (decoded)"
    lambda: |-
      int v = (int) id(${device_id}_parity_code_reg).state;
      switch (v) {
        case 0: return {"none"};
        case 1: return {"odd"};
        case 2: return {"even"};
        default: return {"unknown"};
      }
    update_interval: ${update_interval}

number:
  - platform: modbus_controller
    modbus_controller_id: ${device_id}_modbus
    name: "${name} Channel 1 Analog Code Set"
    id: ${device_id}_ch1_analog_code_set
    register_type: holding
    address: 0x0000
    value_type: U_WORD
    min_value: 0
    max_value: 4095
    step: 1
    force_new_range: true

  - platform: modbus_controller
    modbus_controller_id: ${device_id}_modbus
    name: "${name} Channel 2 Analog Code Set"
    id: ${device_id}_ch2_analog_code_set
    register_type: holding
    address: 0x0001
    value_type: U_WORD
    min_value: 0
    max_value: 4095
    step: 1
    force_new_range: true

  - platform: modbus_controller
    modbus_controller_id: ${device_id}_modbus
    name: "${name} Channel 3 Analog Code Set"
    id: ${device_id}_ch3_analog_code_set
    register_type: holding
    address: 0x0002
    value_type: U_WORD
    min_value: 0
    max_value: 4095
    step: 1
    force_new_range: true

  - platform: modbus_controller
    modbus_controller_id: ${device_id}_modbus
    name: "${name} Channel 4 Analog Code Set"
    id: ${device_id}_ch4_analog_code_set
    register_type: holding
    address: 0x0003
    value_type: U_WORD
    min_value: 0
    max_value: 4095
    step: 1
    force_new_range: true

  - platform: modbus_controller
    modbus_controller_id: ${device_id}_modbus
    name: "${name} Device Address Set"
    id: ${device_id}_device_address_set
    register_type: holding
    address: 0x07D0
    value_type: U_WORD
    min_value: 1
    max_value: 254
    step: 1
    mode: box
    entity_category: config
    on_value:
      then:
        - lambda: |-
            id(${device_id}_modbus).set_address((int)x);

select:
  - platform: modbus_controller
    modbus_controller_id: ${device_id}_modbus
    id: ${device_id}_baud_rate_set
    name: "${name} Baud Rate Set"
    address: 0x07D1
    entity_category: config
    optionsmap:
      "2400": 0
      "4800": 1
      "9600": 2
      "19200": 3
      "38400": 4
      "57600": 5
      "115200": 6
      "1200": 7

  - platform: modbus_controller
    modbus_controller_id: ${device_id}_modbus
    id: ${device_id}_parity_set
    name: "${name} Parity Set"
    address: 0x07D2
    entity_category: config
    optionsmap:
      "none": 0
      "odd": 1
      "even": 2
